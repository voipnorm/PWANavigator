<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Conditions and Air Quality</title>
</head>
<style>
    body {
        background-color: lightgray;
        width: 100vw;
    }
    .container {
        height: 400px;
        position: relative;

    }

</style>
<body>
<div class="container">
    <div class="center">
        <h1>Current Room Conditions and Air Quality</h1>
        <p>Temperature: <span id="temperature">Loading...</span> &deg;C</p>
        <p>Humidity: <span id="humidity">Loading...</span>%</p>
        <p>Air Quality: <span id="airQuality">Loading...</span></p>
        <p>Errors: <span id="error">Loading...</span> </p>
    </div>
</div>


<script>
    async function init() {
        try {
            let xapi = await getXAPI();
            //let xapistatus.textContent = "jsxapi available";
            let unique_id = createPersistentCookie();
            //content.textContent = "Navigator ID: " + unique_id;
            //setupSubscriptions();
            await getCurrent();
        } catch(e) {
            document.getElementById('error').textContent = e.message;
            //content.textContent = e.message;
            //xapistatus.textContent = "error getting jsxapi object";
        }
    }

    window.onload = async function() {
        await init();
    };

    function createPersistentCookie() {
        value_or_null = (document.cookie.match(/^(?:.*;)?\s*uniqueId\s*=\s*([^;]+)(?:.*)?$/)||[,null])[1]
        var ret_val;
        if(value_or_null == null) {
            var expiration_date = new Date();
            var cookie_string = '';
            expiration_date.setFullYear(expiration_date.getFullYear() + 1);
            cookie_string = "uniqueId=" + uuidv4() +"; path=/; expires=" + expiration_date.toUTCString();
            document.cookie = cookie_string;
        }
        return (document.cookie.match(/^(?:.*;)?\s*uniqueId\s*=\s*([^;]+)(?:.*)?$/)||[,null])[1];
    }

    function uuidv4() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    async function getCurrent() {
        try{
            let data = {}
            const temp = await xapi.Status.RoomAnalytics.AmbientTemperature.get()
            data.temperature = temp;
            const hum = await xapi.Status.RoomAnalytics.RelativeHumidity.get()
            data.humidity = hum;
            const aq = await xapi.Status.RoomAnalytics.AirQuality.Index.get()
            data.airQuality = aq;
            await updatePanel(data)
            return
        }catch(e){
            console.error(e);
            document.getElementById('error').textContent = e;
        }
    }

    async function updatePanel(data) {
        document.getElementById('temperature').textContent = data.temperature + ' &deg;C';
        document.getElementById('humidity').textContent = data.humidity + '%';
        document.getElementById('airQuality').textContent = data.airQuality;
        return
    }

</script>
</body>
</html>